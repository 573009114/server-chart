# rancher

Chart for installing Rancher Server to manage Kubernetes clusters across providers.

Rancher Resources:

* Rancher Docs: https://rancher.com/docs/rancher/v2.x/en/
* GitHub: https://github.com/rancher/rancher
* DockerHub Images: https://hub.docker.com/r/rancher/rancher

> NOTE: We recommend a small dedicated cluster for running Rancher Server.  Rancher will integrate with the local cluster and use the clusters etcd database as its database.

## Prerequisites

### nginx-ingress

This chart requires the `nginx-ingress` Ingress Controller.

Rancher's [RKE](https://github.com/rancher/rke) Kubernetes cluster build tool installs `nginx-ingress` by default.

Other distributions of Kubernetes may require you to install the `nginx-ingress` controller.

You can find the chart here: [nginx-ingress](https://github.com/kubernetes/charts/tree/master/stable/nginx-ingress)

> NOTE: If you're going to use the Rancher Self-Signed certificates, see the special instructions for setting up SSL passthrough.

## Installing Rancher

Rancher server is designed to be "secure by default" and requires SSL/TLS configuration.  There are several options for where to terminate SSL.

* `rancher` - Use Rancher generated self-signed certs.
* `ingress` - Provide a certificate or use LetsEncrypt to automatically issue a trusted cert for the Ingress.
* `external` - Configure certificates on a external load balancer or other proxy.

### SSL: `tls=rancher` - Pass Through to the Rancher Server

The default is to use the certs generated by Rancher server.

First you will need to configure your Ingress to enable SSL passthrough.

#### Passthrough: RKE install

Add the following `ingress` section to your RKE `cluster.yaml`

```yaml
ingress:
  provider: nginx
  extra_args:
    enable-ssl-passthrough: ""
```

#### Passthrough: nginx-ingress from Helm Chart

If you're using `nginx-ingress` helm catalog add `--set controller.extraArgs.enable-ssl-passthrough=""` to your `helm install` command.

```shell
helm install stable/nginx-ingress --name nginx-ingress --namespace ingress \
--set controller.extraArgs.enable-ssl-passthrough=""
```

#### Install

Set  `hostname` and install the chart.

```shell
helm install stable/rancher --name rancher --namespace rancher-system \
--set tls=rancher \
--set hostname=your.domain.name.com
```

### SSL: `tls=ingress` - TLS Configured at the Ingress

There are two options for the source of the certificate.

* `letsEncrypt` - Use [LetsEncrypt](https://letsencrypt.org/) to issue a cert.
* `secret` - Configure a Kubernetes Secret with your certificate files.

#### `ingress.tls.source=letsEncrypt` - LetsEncrypt

In order to use LetsEncrypt's free service to issue trusted SSL certs, the Ingress must have a Public DNS record and be accessible from the internet.

First install the `cert-manager` chart from Kubernetes Stable to manage the LetsEncrypt cert issuing and renewal.

```shell
helm install stable/cert-manager --name cert-manager --namespace kube-system
```

Now install Rancher with the LetsEncrypt options.

```shell
helm install rancher-server/rancher --name rancher --namespace rancher-system \
--set hostname=your.domain.name.com \
--set tls=ingress \
--set ingress.tls.source=letsEncrypt \
--set letsEncrypt.email=<your email> \
--set letsEncrypt.environment=prod
```

> LetsEncrypt ProTip: The `prod` environment only allows you to register a name 5 times in a week. Use `staging` until you have you're confident the config is right.

#### Ingress Certs from Files (Kubernetes Secret)

The default source for the cert is a Kubernetes Secret.  Set `tls=ingress` and `hostname` to your cert common name.

> NOTE: If you are using a private CA signed cert, add `--set privateCA=true`

```shell
helm install stable/rancher --name rancher --namespace rancher-system \
--set hostname=your.domain.name.com \
--set tls=ingress
```

Now that Rancher is running, see [Adding TLS Secrets](#Adding-TLS-Secrets) to publish the certificate files so Rancher and the Ingress Controller can use them.

### SSL: `tls=external` - External SSL Termination

If you're going to handle the SSL termination on a load balancer or proxy before the Ingress, set `tls=external`

> NOTE: If you are using a private CA signed cert, you will need to provide the CA cert to Rancher server. Add `--set privateCA=true` option and see [Private CA Signed - Additional Steps](#Private-CA-Signed---Additional-Steps).

```shell
helm install stable/rancher --name rancher --namespace rancher-system \
--set hostname=your.domain.name.com \
--set tls=external
```

## Adding TLS Secrets

Kubernetes will create all the objects and services for Rancher, but it will not become available until we populate the `rancher-tls` secret in the `rancher-system` namespace with the certificate and key.

Combine the server certificate followed by the intermediate cert chain your CA provided into a file named `tls.crt`. Copy your key into a file name `tls.key`.

> NOTE: The file names are important. The `kubectl create secret` command will create a secret with 2 key/value pairs.  `kubectl` will use the file name as the key name.

Use `kubectl` to create the secrets

```shell
kubectl -n rancher-system create secret generic tls-rancher --from-file=tls.crt --from-file=tls.key
```

### Private CA Signed - Additional Steps

Rancher will need to have a copy of the CA cert to include when generating agent configs.

Copy the CA cert into a file named `cacerts.pem` and use `kubectl` to create the `tls-rancher-server` secret.

```shell
kubectl -n rancher-system create secret generic tls-rancher-server --from-file=cacerts.pem
```

## Common Options

| Option | Default Value | Description |
| --- | --- | --- |
| `hostname` | "rancher.localhost" | `string` - the Fully Qualified Domain Name for your Rancher Server |
| `tls` | "rancher" | `string` - Where to terminate ssl/tls - "rancher, ingress, external" |
| `ingress.tls.source` | "secret" | `string` - Where to get the cert for the ingress. - "letsEncrypt, secret" |
| `letsEncrypt.email` | "none@example.com" | `string` - Your email address |
| `letsEncrypt.environment` | "staging" | `string` - Valid options: "staging, production" |
| `privateCA` | false | `bool` - Set to true if your cert is signed by a private CA |
| `replicas` | 1 | `int` - number of rancher server replicas |

## Other Options

| Option | Default Value | Description |
| --- | --- | --- |
| `debug` | false | `bool` - set debug flag on rancher server |
| `imagePullSecrets` | [] | `list` - list of names of Secret resource containing private registry credentials |
| `resources` | {} | `map` - rancher pod resource requests & limits |
| `rancherImage` | "rancher/rancher" | `string` - rancher image source |
| `rancherImageTag` | same as chart version | `string` - rancher/rancher image tag |

## HA

The default install runs Rancher with 1 replica.  Scale up after launching or use the `--set replicas=3` option.

## Hostname

The default install sets `rancher.localhost` as the fully qualified domain name to access Rancher. Use the `hostname=` option to set it for your environment.

## Private or Air Gap Registry

You can point to a private registry for an "Air Gap" install.

### Create Registry Secret

Create a Registry secret in the `rancher-system` namespace. Check out the instructions here: https://kubernetes.io/docs/tasks/configure-pod-container/pull-image-private-registry/

### Registry Options

Add the `rancherImage` to point to your private registry image and `imagePullSecrets` to your install command.

```shell
--set rancherImage=private.reg.org:5000/rancher \
--set imagePullSecrets[0].name=secretName
```

## Connecting to Rancher

Rancher should now be accessible. Browse to `https://whatever.hostname.is.set.to`
